<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPI Intents Demo - Vanilla JavaScript</title>
    <script src="https://unpkg.com/qr-creator@1.0.0/dist/qr-creator.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .app-buttons {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .app-button {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-decoration: none;
            color: #333;
            background: white;
            transition: all 0.2s;
        }
        .app-button:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }
        .app-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }
        .qr-container {
            margin-top: 20px;
            text-align: center;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 4px;
            border: 1px solid #d4edda;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .uri-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔗 UPI Intents Library Demo</h1>
        
        <div class="form-group">
            <label for="payeeAddress">Payee Address (VPA):</label>
            <input type="text" id="payeeAddress" placeholder="merchant@paytm" value="demo@upi">
        </div>
        
        <div class="form-group">
            <label for="payeeName">Payee Name:</label>
            <input type="text" id="payeeName" placeholder="Merchant Name" value="Demo Merchant">
        </div>
        
        <div class="form-group">
            <label for="amount">Amount (INR):</label>
            <input type="number" id="amount" placeholder="100.00" value="99.50">
        </div>
        
        <div class="form-group">
            <label for="note">Transaction Note:</label>
            <input type="text" id="note" placeholder="Payment for goods" value="Test payment">
        </div>
        
        <button onclick="generatePaymentLinks()">Generate Payment Links</button>
        <button onclick="generateMandateLinks()">Generate Mandate Links</button>
        <button onclick="clearResults()">Clear</button>
        
        <div id="results"></div>
    </div>

    <script type="module">
        // Import the UPI library (in a real app, this would be from npm)
        // For demo purposes, we'll simulate the library functions
        
        // Mock UPI library functions for demo
        const UpiIntents = {
            createPaymentUri: (pa, pn, am, tn) => {
                const params = new URLSearchParams();
                params.set('pa', pa);
                params.set('pn', pn);
                if (am) {
                    params.set('am', am);
                    params.set('cu', 'INR');
                }
                if (tn) params.set('tn', tn);
                return `upi://pay?${params.toString()}`;
            },
            
            createMandateUri: (pa, pn, am, tn, tr) => {
                const params = new URLSearchParams();
                params.set('pa', pa);
                params.set('pn', pn);
                if (am) {
                    params.set('am', am);
                    params.set('cu', 'INR');
                }
                if (tn) params.set('tn', tn);
                if (tr) params.set('tr', tr);
                return `upi://mandate?${params.toString()}`;
            },
            
            buildAppLink: (options) => {
                const { appId, upiUri, platform } = options;
                const apps = {
                    gpay: {
                        label: 'Google Pay',
                        verified: true,
                        android: 'intent://pay?' + new URL(upiUri).search.slice(1) + '#Intent;scheme=upi;package=com.google.android.apps.nbu.paisa.user;end',
                        ios: 'gpay://upi/pay?' + new URL(upiUri).search.slice(1),
                        fallback: platform === 'android' 
                            ? 'https://play.google.com/store/apps/details?id=com.google.android.apps.nbu.paisa.user'
                            : 'https://apps.apple.com/in/app/google-pay-save-pay-manage/id1193357041'
                    },
                    phonepe: {
                        label: 'PhonePe',
                        verified: false,
                        android: 'intent://pay?' + new URL(upiUri).search.slice(1) + '#Intent;scheme=upi;package=com.phonepe.app;end',
                        ios: 'phonepe://pay?' + new URL(upiUri).search.slice(1),
                        fallback: platform === 'android' 
                            ? 'https://play.google.com/store/apps/details?id=com.phonepe.app'
                            : 'https://apps.apple.com/in/app/phonepe-upi-payments-recharge/id1170055821'
                    },
                    paytm: {
                        label: 'Paytm',
                        verified: false,
                        android: 'intent://pay?' + new URL(upiUri).search.slice(1) + '#Intent;scheme=upi;package=net.one97.paytm;end',
                        ios: 'paytmmp://pay?' + new URL(upiUri).search.slice(1),
                        fallback: platform === 'android' 
                            ? 'https://play.google.com/store/apps/details?id=net.one97.paytm'
                            : 'https://apps.apple.com/in/app/paytm-secure-upi-payments/id473941634'
                    },
                    generic: {
                        label: 'Any UPI App',
                        verified: true,
                        android: upiUri,
                        ios: upiUri,
                        fallback: null
                    }
                };
                
                const app = apps[appId];
                if (!app) throw new Error(`Unknown app: ${appId}`);
                
                return {
                    url: platform === 'android' ? app.android : app.ios,
                    fallbackUrl: app.fallback,
                    app: { id: appId, label: app.label, verified: app.verified },
                    platform,
                    action: upiUri.includes('mandate') ? 'mandate' : 'pay'
                };
            },
            
            detectPlatform: () => {
                const ua = navigator.userAgent.toLowerCase();
                return /iphone|ipad|ipod/.test(ua) ? 'ios' : 'android';
            },
            
            generateQRCode: (upiUri) => {
                // Create QR code using qr-creator library
                const canvas = document.createElement('canvas');
                canvas.width = 150;
                canvas.height = 150;
                
                // Use the global QrCreator from the CDN
                if (window.QrCreator) {
                    window.QrCreator.render({
                        text: upiUri,
                        radius: 0.0,
                        ecLevel: 'M',
                        fill: '#000000',
                        background: '#ffffff',
                        size: 150
                    }, canvas);
                }
                
                // Also create SVG version
                const svgContainer = document.createElement('div');
                if (window.QrCreator) {
                    window.QrCreator.render({
                        text: upiUri,
                        radius: 0.0,
                        ecLevel: 'M',
                        fill: '#000000',
                        background: '#ffffff',
                        size: 150
                    }, svgContainer);
                }
                
                const svgElement = svgContainer.querySelector('svg');
                const svgString = svgElement ? svgElement.outerHTML : `
                    <svg width="150" height="150" viewBox="0 0 150 150" xmlns="http://www.w3.org/2000/svg">
                        <rect width="150" height="150" fill="white"/>
                        <text x="75" y="75" text-anchor="middle" font-size="12">QR Code</text>
                        <text x="75" y="90" text-anchor="middle" font-size="8">Scan with UPI app</text>
                    </svg>
                `;
                
                return {
                    svg: svgString,
                    dataUrl: canvas.toDataURL('image/png'),
                    text: upiUri
                };
            }
        };
        
        // Make functions globally available
        window.UpiIntents = UpiIntents;
        
        // Helper functions
        window.generatePaymentLinks = function() {
            try {
                const pa = document.getElementById('payeeAddress').value.trim();
                const pn = document.getElementById('payeeName').value.trim();
                const am = document.getElementById('amount').value.trim();
                const tn = document.getElementById('note').value.trim();
                
                if (!pa || !pn) {
                    throw new Error('Payee address and name are required');
                }
                
                const upiUri = UpiIntents.createPaymentUri(pa, pn, am, tn);
                generateAppButtons(upiUri, 'pay');
            } catch (error) {
                showError(error.message);
            }
        };
        
        window.generateMandateLinks = function() {
            try {
                const pa = document.getElementById('payeeAddress').value.trim();
                const pn = document.getElementById('payeeName').value.trim();
                const am = document.getElementById('amount').value.trim();
                const tn = document.getElementById('note').value.trim();
                const tr = 'MANDATE-' + Date.now(); // Generate mandate reference
                
                if (!pa || !pn) {
                    throw new Error('Payee address and name are required');
                }
                
                const upiUri = UpiIntents.createMandateUri(pa, pn, am, tn, tr);
                generateAppButtons(upiUri, 'mandate');
            } catch (error) {
                showError(error.message);
            }
        };
        
        function generateAppButtons(upiUri, action) {
            const platform = UpiIntents.detectPlatform();
            const apps = ['gpay', 'phonepe', 'paytm', 'generic'];
            
            let html = `
                <div class="results">
                    <h3>Generated ${action.toUpperCase()} Links (${platform.toUpperCase()})</h3>
                    <div class="uri-display">${upiUri}</div>
                    <div class="app-buttons">
            `;
            
            apps.forEach(appId => {
                try {
                    const link = UpiIntents.buildAppLink({ appId, upiUri, platform });
                    const verifiedBadge = link.app.verified ? '✅' : '⚠️';
                    
                    html += `
                        <a href="${link.url}" class="app-button" onclick="trackClick('${appId}', '${platform}')">
                            <span class="app-icon">${verifiedBadge}</span>
                            <span>${link.app.label}</span>
                        </a>
                    `;
                    
                    if (link.fallbackUrl && platform === 'ios') {
                        html += `
                            <a href="${link.fallbackUrl}" class="app-button" style="opacity: 0.7;">
                                <span class="app-icon">📱</span>
                                <span>Get ${link.app.label}</span>
                            </a>
                        `;
                    }
                } catch (error) {
                    console.error(`Failed to generate link for ${appId}:`, error);
                }
            });
            
            html += `
                    </div>
                    <div class="qr-container">
                        <h4>QR Code (Desktop/Fallback)</h4>
                        <div id="qr-code"></div>
                        <button onclick="downloadQR('${upiUri}')">Download QR</button>
                    </div>
                </div>
            `;
            
            document.getElementById('results').innerHTML = html;
            
            // Generate QR code
            const qr = UpiIntents.generateQRCode(upiUri);
            document.getElementById('qr-code').innerHTML = qr.svg;
        }
        
        window.trackClick = function(appId, platform) {
            console.log(`Clicked ${appId} on ${platform}`);
            // In a real app, you'd send analytics here
        };
        
        window.downloadQR = function(upiUri) {
            const qr = UpiIntents.generateQRCode(upiUri);
            const link = document.createElement('a');
            link.href = qr.dataUrl;
            link.download = 'upi-payment-qr.svg';
            link.click();
        };
        
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };
        
        function showError(message) {
            document.getElementById('results').innerHTML = `
                <div class="results error">
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }
        
        // Auto-generate on page load for demo
        window.onload = function() {
            generatePaymentLinks();
        };
    </script>
</body>
</html>